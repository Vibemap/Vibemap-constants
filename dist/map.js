"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var geoViewport=require("@mapbox/geo-viewport"),Axios=require("axios"),turf=require("@turf/helpers"),meta=require("@turf/meta"),clusters=require("@turf/clusters"),bboxPolygon=require("@turf/bbox-polygon"),turf_center=require("@turf/center"),turf_distance=require("@turf/distance"),turf_truncate=require("@turf/truncate"),clustersDbscan=require("@turf/clusters-dbscan"),pointsWithinPolygon=require("@turf/points-within-polygon"),rhumbBearing=require("@turf/rhumb-bearing"),rhumbDistance=require("@turf/rhumb-distance"),rhumbDestination=require("@turf/rhumb-destination"),querystring=require("querystring");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function _interopNamespace(r){if(r&&r.__esModule)return r;var a=Object.create(null);return r&&Object.keys(r).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(r,e),Object.defineProperty(a,e,t.get?t:{enumerable:!0,get:function(){return r[e]}}))}),a.default=r,Object.freeze(a)}var geoViewport__default=_interopDefaultLegacy(geoViewport),Axios__default=_interopDefaultLegacy(Axios),turf__namespace=_interopNamespace(turf),bboxPolygon__default=_interopDefaultLegacy(bboxPolygon),turf_center__default=_interopDefaultLegacy(turf_center),turf_distance__default=_interopDefaultLegacy(turf_distance),turf_truncate__default=_interopDefaultLegacy(turf_truncate),clustersDbscan__default=_interopDefaultLegacy(clustersDbscan),pointsWithinPolygon__default=_interopDefaultLegacy(pointsWithinPolygon),rhumbBearing__default=_interopDefaultLegacy(rhumbBearing),rhumbDistance__default=_interopDefaultLegacy(rhumbDistance),rhumbDestination__default=_interopDefaultLegacy(rhumbDestination),querystring__default=_interopDefaultLegacy(querystring);const getMax=(e,t)=>{let r=0;return e.forEach(e=>{e=e.properties[t];e>r&&(r=e)}),r},geocodeAddress=async(e="AIzaSyAJfpSSx6pudnbjILmdUPBG7O4Diu2RHgE",t="Red Bay Coffee Roasers",r=null)=>{const a=new URLSearchParams({address:t,key:e});if(null==e)return{error:!0,data:null,message:"No API key provided."};t="https://maps.googleapis.com/maps/api/geocode/json?"+a.toString()+(r?"&components=locality="+r:""),r=await Axios__default.default.get(t).catch(e=>(console.log("error ",e),{error:!0,data:null})),t=r&&r.data&&r.data.results?r.data.results:null;return t&&0<t.length&&t[0].place_id?(e=await getPlaceDetails(e,t[0].place_id),console.log("Got place id, look it up: ",t,e),{error:!1,data:{place:e.data,results:t}}):{error:!1,data:{place:null,results:r.data}}},getPlaceDetails=async(e=null,t="ChIJAQDsXLeAj4ARx-92_aeMjX4")=>{if(null==e)return{error:!0,data:null,message:"No API key provided."};const r=new URLSearchParams({key:e,place_id:t});e="https://maps.googleapis.com/maps/api/place/details/json?"+r.toString(),t=await Axios__default.default.get(e).catch(e=>(console.log("error ",e),{error:!0,data:null}));if(t.error||null==t.data||!t.data.result)return{error:!0,data:t.data};e=t.data.result;return{error:!1,data:{...e,address:e.formatted_address,url:e.website}}},getPlaceSocial=async(e,t="Vibemap",r="08cefff08b1db59b1")=>{if(null==e)return{error:!0,data:null,message:"No API key provided."};const a=new URLSearchParams({key:e,q:t,cx:r});console.log("Params to strng ",a.toString());e=`GET https://customsearch.googleapis.com/customsearch/v1
        ?${a.toString()} HTTP/1.1`,t=await Axios__default.default.get(e).catch(e=>(console.log("error ",e),{error:!0,data:e}));console.log("Response ",t)},getArea=e=>{return turf_distance__default.default([e[0],e[1]],[e[0],e[3]],{units:"miles"})*turf_distance__default.default([e[0],e[1]],[e[2],e[1]],{units:"miles"})},getBounds=(e,t,r)=>{return geoViewport__default.default.bounds([e.longitude,e.latitude],t,[r.width,r.height],512)},getClusters=(e,t)=>{e=turf.featureCollection(e);let s=[];e=clustersDbscan__default.default(e,t/1e3,{mutate:!0,minPoints:2});return clusters.clusterEach(e,"cluster",function(e,t){if("null"!==t){let n=turf_center__default.default(e),u=getMax(e.features,"average_score");e.features.length,meta.featureEach(e,function(e,t){let r=e.properties;r.vibes_score;var a=rhumbDistance__default.default(n,e),o=rhumbBearing__default.default(n,e),a=rhumbDestination__default.default(n,2*a,o);r.offset=a.geometry,r.in_cluster=!0,r.top_in_cluster=!1,r.average_score>=u?r.top_in_cluster=!0:r.icon_size=r.icon_size/2,e.properties=r,s.push(e)})}else meta.featureEach(e,function(e,t){e.properties.in_cluster=!1,e.properties.top_in_cluster=!0,s.push(e)})}),s=s.sort((e,t)=>t.properties.average_score-e.properties.average_score)},getDistance=(e,t)=>{return turf_distance__default.default([e[0],e[1]],[t[0],t[1]],{units:"miles"})},getDistanceToPixels=(e,t)=>{var r=e[0],a=e[1],e=e[2];return turf_distance__default.default([r,a],[e,a],{unit:"miles"})/t.width},getFeaturesInBounds=(e,t)=>{e=turf.featureCollection(e),t=bboxPolygon__default.default(t.flat());return pointsWithinPolygon__default.default(e,t).features},getDirections=async(u,s,i="walking")=>new Promise(function(t,e){var r=`https://api.mapbox.com/directions/v5/mapbox/${i}/`,a=querystring__default.default.stringify({access_token:s,geometries:"geojson",steps:!0,waypoints:[]}),o=u[0],n=u[u.length-1],o=(String(o),String(n),u.join(";"));fetch(r+o+"?"+a).then(e=>e.json()).then(e=>{t({data:e,loading:!1,timedOut:!1})},e=>{console.log(e)})}),getWaypoints=e=>{return e.map(e=>e.geometry.coordinates)},getBestRoute=e=>{e=e.data.routes[0];return{type:"Feature",properties:{distance:e.distance},geometry:{type:"LineString",coordinates:e.geometry.coordinates}}},getLocationFromPoint=(e=[-122.269994,37.806507])=>{return{centerpoint:e,longitude:e[0],latitude:e[1]}},getPosition=e=>new Promise(function(t,r){navigator.geolocation&&navigator.geolocation.getCurrentPosition||t(!1),navigator.geolocation.getCurrentPosition(function(e){t(e)},function(e){r(!1),console.warn(`ERROR(${e.code}): `+e.message)},{enableHighAccuracy:!0,timeout:4e3})}),getRadius=e=>{return turf_distance__default.default([e[0],e[1]],[e[2],e[3]],{units:"miles"})/2},getFeatureCollection=e=>turf.featureCollection(e),getTruncatedFeatures=e=>turf_truncate__default.default(e,{precision:6,coordinates:2}),sortLocations=(e,t)=>{let o=turf__namespace.point([t.longitude,t.latitude]);return e.sort((e,t)=>{var r=e.centerpoint?turf__namespace.point(e.centerpoint):turf__namespace.point([e.location.longitude,e.location.latitude]),a=t.centerpoint?turf__namespace.point(t.centerpoint):turf__namespace.point([t.location.longitude,t.location.latitude]);return e.distance=turf_distance__default.default(o,r),t.distance=turf_distance__default.default(o,a),e.distance>t.distance?1:-1})},zoomToRadius=e=>{let t=scalePow(1).domain([8,12,13,14,16,18]).range([40,7,3,3.5,1.5,.8]);return t(e)};exports.geocodeAddress=geocodeAddress,exports.getArea=getArea,exports.getBestRoute=getBestRoute,exports.getBounds=getBounds,exports.getClusters=getClusters,exports.getDirections=getDirections,exports.getDistance=getDistance,exports.getDistanceToPixels=getDistanceToPixels,exports.getFeatureCollection=getFeatureCollection,exports.getFeaturesInBounds=getFeaturesInBounds,exports.getLocationFromPoint=getLocationFromPoint,exports.getPlaceDetails=getPlaceDetails,exports.getPlaceSocial=getPlaceSocial,exports.getPosition=getPosition,exports.getRadius=getRadius,exports.getTruncatedFeatures=getTruncatedFeatures,exports.getWaypoints=getWaypoints,exports.sortLocations=sortLocations,exports.zoomToRadius=zoomToRadius;
