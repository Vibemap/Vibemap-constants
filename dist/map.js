"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var geoViewport=require("@mapbox/geo-viewport"),Axios=require("axios"),turf=require("@turf/helpers"),meta=require("@turf/meta"),clusters=require("@turf/clusters"),bboxPolygon=require("@turf/bbox-polygon"),turf_center=require("@turf/center"),turf_distance=require("@turf/distance"),turf_truncate=require("@turf/truncate"),clustersDbscan=require("@turf/clusters-dbscan"),pointsWithinPolygon=require("@turf/points-within-polygon"),rhumbBearing=require("@turf/rhumb-bearing"),rhumbDistance=require("@turf/rhumb-distance"),rhumbDestination=require("@turf/rhumb-destination"),chroma=require("chroma-js"),querystring=require("querystring");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var geoViewport__default=_interopDefaultLegacy(geoViewport),Axios__default=_interopDefaultLegacy(Axios),bboxPolygon__default=_interopDefaultLegacy(bboxPolygon),turf_center__default=_interopDefaultLegacy(turf_center),turf_distance__default=_interopDefaultLegacy(turf_distance),turf_truncate__default=_interopDefaultLegacy(turf_truncate),clustersDbscan__default=_interopDefaultLegacy(clustersDbscan),pointsWithinPolygon__default=_interopDefaultLegacy(pointsWithinPolygon),rhumbBearing__default=_interopDefaultLegacy(rhumbBearing),rhumbDistance__default=_interopDefaultLegacy(rhumbDistance),rhumbDestination__default=_interopDefaultLegacy(rhumbDestination),chroma__default=_interopDefaultLegacy(chroma),querystring__default=_interopDefaultLegacy(querystring);const getMax=(e,t)=>{let r=0;return e.forEach(e=>{e=e.properties[t];e>r&&(r=e)}),r},geocodeAddress=async(e=null,t="1600 Amphitheatre Parkway Mountain+View")=>{const r=new URLSearchParams({address:t,key:e});if(null==e)return{error:!0,data:null,message:"No API key provided."};var t="https://maps.googleapis.com/maps/api/geocode/json?"+r.toString(),t=await Axios__default.default.get(t).catch(e=>(console.log("error ",e),{error:!0,data:null})),a=t&&t.data.results?t.data.results:null;return a&&a[0].place_id?(e=await getPlaceDetails(e,a[0].place_id),console.log("Got place id, look it up: ",e),{error:!1,data:{place:e.data,results:a}}):{error:!1,data:{place:null,results:t.data}}},getPlaceDetails=async(e=null,t="ChIJAQDsXLeAj4ARx-92_aeMjX4")=>{if(null==e)return{error:!0,data:null,message:"No API key provided."};const r=new URLSearchParams({key:e,place_id:t});e="https://maps.googleapis.com/maps/api/place/details/json?"+r.toString(),t=(await Axios__default.default.get(e).catch(e=>(console.log("error ",e),{error:!0,data:null}))).data.result;return{error:!1,data:{...t,address:t.formatted_address,url:t.website}}},getPlaceSocial=async(e,t="Vibemap",r="08cefff08b1db59b1")=>{if(null==e)return{error:!0,data:null,message:"No API key provided."};const a=new URLSearchParams({key:e,q:t,cx:r});console.log("Params to strng ",a.toString());e=`GET https://customsearch.googleapis.com/customsearch/v1
        ?${a.toString()} HTTP/1.1`,t=await Axios__default.default.get(e).catch(e=>(console.log("error ",e),{error:!0,data:e}));console.log("Response ",t)},getArea=e=>{return turf_distance__default.default([e[0],e[1]],[e[0],e[3]],{units:"miles"})*turf_distance__default.default([e[0],e[1]],[e[2],e[1]],{units:"miles"})},getBounds=(e,t,r)=>{return geoViewport__default.default.bounds([e.longitude,e.latitude],t,[r.width,r.height],512)},getClusters=(e,t)=>{e=turf.featureCollection(e);let i=[];e=clustersDbscan__default.default(e,t/1e3,{mutate:!0,minPoints:2});return clusters.clusterEach(e,"cluster",function(e,t){if("null"!==t){let s=turf_center__default.default(e),u=getMax(e.features,"average_score");e.features.length,meta.featureEach(e,function(e,t){let r=e.properties;r.vibes_score;var a=rhumbDistance__default.default(s,e),o=rhumbBearing__default.default(s,e),a=rhumbDestination__default.default(s,2*a,o);r.offset=a.geometry,r.in_cluster=!0,r.top_in_cluster=!1,r.average_score>=u?r.top_in_cluster=!0:r.icon_size=r.icon_size/2,e.properties=r,i.push(e)})}else meta.featureEach(e,function(e,t){e.properties.in_cluster=!1,e.properties.top_in_cluster=!0,i.push(e)})}),i=i.sort((e,t)=>t.properties.average_score-e.properties.average_score)},getDistance=(e,t)=>{return turf_distance__default.default([e[0],e[1]],[t[0],t[1]],{units:"miles"})},getDistanceToPixels=(e,t)=>{var r=e[0],a=e[1],e=e[2];return turf_distance__default.default([r,a],[e,a],{unit:"miles"})/t.width},getFeaturesInBounds=(e,t)=>{e=turf.featureCollection(e),t=bboxPolygon__default.default(t.flat());return pointsWithinPolygon__default.default(e,t).features},getHeatmap=(e,t)=>{let r=[];var a="#F8EE32",o="#FFFFFF",s="#9DE862",u="#7DCAA5",i="#BC94C4",n="#FFFCC5",l="#F09C1F";let c=t?{calm:[o,"#54CAF2",s,n],buzzing:[o,"#E479B0",l,n],dreamy:[o,i,l,n],oldschool:["#008ae5",a,l],playful:[o,u,s,a],solidarity:[o,n,a,l],together:[o,u,n],wild:"PiYG"}[t]:[o,i,a,l];return e&&(c=chroma__default.default.scale([e])),r=(r=chroma__default.default.scale(c).mode("lch").colors(6)).map((e,t)=>{var r=.2*t,e=chroma__default.default(e).alpha(r).saturate(.05*t).css();return console.log("heat layer ",t,e),e})},getDirections=async(u,i,n="walking")=>new Promise(function(t,e){var r=`https://api.mapbox.com/directions/v5/mapbox/${n}/`,a=querystring__default.default.stringify({access_token:i,geometries:"geojson",steps:!0,waypoints:[]}),o=u[0],s=u[u.length-1],o=(String(o),String(s),u.join(";"));fetch(r+o+"?"+a).then(e=>e.json()).then(e=>{t({data:e,loading:!1,timedOut:!1})},e=>{console.log(e)})}),getWaypoints=e=>{return e.map(e=>e.geometry.coordinates)},getBestRoute=e=>{e=e.data.routes[0];return{type:"Feature",properties:{distance:e.distance},geometry:{type:"LineString",coordinates:e.geometry.coordinates}}},getPosition=e=>new Promise(function(t,r){navigator.geolocation&&navigator.geolocation.getCurrentPosition||t(!1),navigator.geolocation.getCurrentPosition(function(e){t(e)},function(e){r(!1),console.warn(`ERROR(${e.code}): `+e.message)},{enableHighAccuracy:!0,timeout:4e3})}),getRadius=e=>{return turf_distance__default.default([e[0],e[1]],[e[2],e[3]],{units:"miles"})/2},getFeatureCollection=e=>turf.featureCollection(e),getTruncatedFeatures=e=>turf_truncate__default.default(e,{precision:6,coordinates:2}),zoomToRadius=e=>{let t=scalePow(1).domain([8,12,13,14,16,18]).range([40,7,3,3.5,1.5,.8]);return t(e)};exports.geocodeAddress=geocodeAddress,exports.getArea=getArea,exports.getBestRoute=getBestRoute,exports.getBounds=getBounds,exports.getClusters=getClusters,exports.getDirections=getDirections,exports.getDistance=getDistance,exports.getDistanceToPixels=getDistanceToPixels,exports.getFeatureCollection=getFeatureCollection,exports.getFeaturesInBounds=getFeaturesInBounds,exports.getHeatmap=getHeatmap,exports.getPlaceDetails=getPlaceDetails,exports.getPlaceSocial=getPlaceSocial,exports.getPosition=getPosition,exports.getRadius=getRadius,exports.getTruncatedFeatures=getTruncatedFeatures,exports.getWaypoints=getWaypoints,exports.zoomToRadius=zoomToRadius;
