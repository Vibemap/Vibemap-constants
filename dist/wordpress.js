"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Axios=require("axios"),axiosRetry=require("axios-retry");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var Axios__default=_interopDefaultLegacy(Axios),axiosRetry__default=_interopDefaultLegacy(axiosRetry);axiosRetry__default.default(Axios__default.default,{retries:3,retryDelay:axiosRetry__default.default.exponentialDelay});const jsonpack=require("jsonpack"),GATSBY_WP_BASEURL="https://cms.vibemap.com",REST_PATH="/wp-json/wp/v2/",helpers=require("./helpers.js"),cities=helpers.cities,postCategories=require("../dist/postCategories");let vibeTaxonomy=[],activityCategories=[];try{const b=require("../dist/vibesFromCMSTaxonomy.zip.json");vibeTaxonomy=jsonpack.unpack(b)}catch(e){console.log("Error with packed vibes ",e)}try{const d=require("../dist/activityCategories.zip.json");activityCategories=jsonpack.unpack(d)}catch(e){console.log("Error with packed activityCategories ",e)}const defaultFilters={categories:[],cities:[],vibesets:[],vibes:[]},getTaxonomyIds=(e,t=["chill"])=>{switch(e){case"category":return t.map(e=>{const t=helpers.filterList(activityCategories,e,"slug");return 0<t.length?t.map(e=>e.id):[]});case"vibe":return t.map(e=>{const t=helpers.filterList(vibeTaxonomy,e,"slug");return 0<t.length?t.map(e=>e.id):[]});case"cities":return t.map(e=>{const t=helpers.filterList(helpers.cities,e,"slug",!0);e=t.map(e=>e&&e.id_wordpress?e.id_wordpress:e.id);return 0<t.length?e:[]})}return[]},fetchBadges=async(e=100)=>{e=GATSBY_WP_BASEURL+REST_PATH+"badges?per_page="+e;return await Axios__default.default.get(e).catch(e=>console.error(e))},fetchCities=async(e=100)=>{e=`?_fields=id, link, name, radius, slug, title, acf, type
      &per_page=`+e,e=GATSBY_WP_BASEURL+REST_PATH+"city"+e;return await Axios__default.default.get(e).catch(e=>console.error(e))},fetchNeighborhoods=async(s=defaultFilters,e=1,i=10)=>{var t=async(e=1)=>{const t=["id","slug","type","link","title","categories","vibe","acf","featured_media","featured_media_src_url"];var a="?_fields="+t.join(","),r=Math.random(),a=GATSBY_WP_BASEURL+`/wp-json/wp/v2/neighborhoods${a}&refresh=`+r;let o=await Axios__default.default.get(a,{headers:{Accept:"application/json","Content-Type":"application/json",Cookie:"PHPSESSID=fc445d3668b82ce450818bff8f864d1d"},maxBodyLength:1/0,params:{_embed:!1,fields:t.join(","),per_page:i,page:1<=e?e:1,categories:s.category,vibesets:s.vibesets.toString()}}).catch(e=>{console.error(e)});return o.numPages=parseInt(o.headers["x-wp-totalpages"]),o.data};let a=await t(e),r=!0;var o;let c=e;for(console.log("Has more?  ",a.length,c*i);r;)a.length>=c*i?(o=await t(c+=1).catch(e=>console.error(e)),a=a.concat(o)):r=!1;return a},fetchActivityCategories=async(e=defaultFilters,t=1,a=100,r)=>{var o=async(e=1,t=100)=>{var a=Axios__default.default.CancelToken.source(),r="activity-category",o=Math.random(),t=GATSBY_WP_BASEURL+`/wp-json/wp/v2/${r}?per_page=${t}&page=${e}&refresh=`+o,e=(console.log(`Fetching ${r} from `+t),await Axios__default.default.get(t,{cancelToken:a.token}).catch(e=>{console.error(e)}));return e.data};let s=await o(t,a),i=!0;var c;let n=t;for(console.log("Has more?  ",s.length,n*a);i;)s.length>=n*a?(c=await o(n+=1).catch(e=>console.error(e)),s=s.concat(c)):i=!1;return console.log("Got this many activities: ",s.length),s},fetchCategories=async(e=defaultFilters,t,a)=>{var r=Axios__default.default.CancelToken.source();let o=await Axios__default.default.get(GATSBY_WP_BASEURL+"/wp-json/wp/v2/categories/",{cancelToken:r.token}).catch(e=>{console.error(e)});return o.numPages=parseInt(o.headers["x-wp-totalpages"]),o},getCityInfo=(t="San Francisco",a=null)=>{let e=null;a&&(a=a.toString(),r=cities.filter(e=>e.slug===a.toString()),e=0<r.length?r[0]:null);var r=cities.filter(e=>e.name===t);return e=0<r.length?r[0]:null},filterNeighborhoods=(e,t="San Francisco",a=null)=>{var r;a&&(a=a.toString(),r=cities.filter(e=>e.slug===a.toString()),t=0<r.length?r[0].title.rendered:null);return t||a?filter(e,e=>e.city===t||e.title.includes(t)):e},fetchVibeTaxonomy=async(e=1,t=100,r=["acf","id","link","name","slug","description"],o=!0)=>{var a=async(e=1,t=100)=>{const a=new Date;t=`?_fields=${r.join(",")}&per_page=${t}&page=`+e,e=GATSBY_WP_BASEURL+REST_PATH+"vibe"+t+(o?"&"+a.toISOString():"");return(await Axios__default.default.get(e).catch(e=>console.error(e))).data};let s=await a(e,t),i=!0;var c;let n=e;for(;i;)s.length>=n*t?(c=await a(n+=1).catch(e=>console.error(e)),s=s.concat(c)):i=!1;return s},getGroups=async({city:t=null,per_page:e=100}={})=>{e="?_fields=id,date,slug,title,acf&per_page="+e,e=GATSBY_WP_BASEURL+REST_PATH+"group"+e;const a=(await Axios__default.default.get(e).catch(e=>(console.error(e.response.statusText),{error:!0,data:{data:[]},message:e}))).data;e=a&&"object"==typeof a?a.filter(e=>{return e.acf.map&&t?t==e.acf.map.city:(e.title=e.title.rendered,!0)}):[];return e?{error:!1,data:e,message:`Got ${e.length} groups`}:{error:!0,data:[],message:"No data for groups"}},getPosts=async(e=defaultFilters,t=!1,a=20,r=["id","date","slug","status","type","link","title","content","excerpt","author","categories","vibe","blocks","acf","featured_media","featured_media_src_url"],o=!1,s=!1)=>{o=o?"&_embed":"",r="?_fields="+r.join(",");const i=new Date;r=""+GATSBY_WP_BASEURL+REST_PATH+"posts"+r+o+(s?"&"+i.toISOString():"");const c={per_page:a,cities:getTaxonomyIds("cities",e.cities).toString(),sticky:!0};e.category&&0<e.category.length&&(c.category=getTaxonomyIds("category",e.category).toString());let n=await Axios__default.default.get(r,{params:c}).catch(e=>{console.error("Wordpress error",e)}),l=(c.sticky=!1,console.log("getPosts endpoint",r,c),await Axios__default.default.get(r,{params:c}).catch(e=>console.error(e)));o=l.data.filter(e=>!0!==e.acf.hide_post).map(t=>{var e=postCategories.filter(e=>e.id===t.categories[0]);return t.category=e?e[0].name:"Guide",t});return!0===t?n:(l.data=l?n.data.concat(o):n,l)},getPost=async e=>{Axios__default.default({url:"https://cms.vibemap.com/graphql",method:"post",data:{operationName:"PostDetails",query:`query PostDetails($id: String!) {
        posts {
          nodes {
            id
            slug
          }
        }
      }
      `,variables:{id:e}}}).then(e=>{console.log(e.data)})};exports.fetchActivityCategories=fetchActivityCategories,exports.fetchBadges=fetchBadges,exports.fetchCategories=fetchCategories,exports.fetchCities=fetchCities,exports.fetchNeighborhoods=fetchNeighborhoods,exports.fetchVibeTaxonomy=fetchVibeTaxonomy,exports.filterNeighborhoods=filterNeighborhoods,exports.getCityInfo=getCityInfo,exports.getGroups=getGroups,exports.getPost=getPost,exports.getPosts=getPosts,exports.getTaxonomyIds=getTaxonomyIds;
//# sourceMappingURL=wordpress.js.map
