"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Axios=require("axios"),axiosRetry=require("axios-retry");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var Axios__default=_interopDefaultLegacy(Axios),axiosRetry__default=_interopDefaultLegacy(axiosRetry),cities=[{id:52306,slug:"peoria",type:"early",location:{latitude:40.6936488,longitude:-89.5889864},centerpoint:[-89.5889864,40.6936488],mailchimp_id:"",radius:10,name:"Peoria"},{id:51835,slug:"toronto",type:"official",location:{latitude:43.653226,longitude:-79.3831843},centerpoint:[-79.3831843,43.653226],mailchimp_id:"95135b1969",radius:20,name:"Toronto"},{id:45678,slug:"houston",type:"official",location:{latitude:29.760314934412516,longitude:-95.36962040978698},centerpoint:[-95.36962040978698,29.760314934412516],mailchimp_id:"ea2fe099f2",radius:30,name:"Houston"},{id:44901,slug:"puerto-vallarta",type:"early",location:{latitude:20.615046993637947,longitude:-105.231817181398},centerpoint:[-105.231817181398,20.615046993637947],mailchimp_id:"57c905a1df",radius:4,name:"Puerto Vallarta"},{id:38387,slug:"austin",type:"early",location:{latitude:30.267153,longitude:-97.7430608},centerpoint:[-97.7430608,30.267153],mailchimp_id:"1d933c234f",radius:20,name:"Austin"},{id:38380,slug:"denver",type:"official",location:{latitude:39.7392358,longitude:-104.990251},centerpoint:[-104.990251,39.7392358],mailchimp_id:"b576abf895",radius:20,name:"Denver"},{id:38148,slug:"chicago",type:"official",location:{latitude:41.8781136,longitude:-87.6297982},centerpoint:[-87.6297982,41.8781136],mailchimp_id:"b865b3ef72",radius:20,name:"Chicago"},{id:38143,slug:"new-york",type:"official",location:{latitude:40.7127610684055,longitude:-74.0060103509262},centerpoint:[-74.0060103509262,40.7127610684055],mailchimp_id:"56ebd9923f",radius:20,name:"New York"},{id:38137,slug:"san-diego",type:"official",location:{latitude:32.715738,longitude:-117.1610838},centerpoint:[-117.1610838,32.715738],mailchimp_id:"7fb6e2a465",radius:20,name:"San Diego"},{id:38119,slug:"los-angeles",type:"official",location:{latitude:34.04734503476973,longitude:-118.25308336038819},centerpoint:[-118.25308336038819,34.04734503476973],mailchimp_id:"7fb6e2a465",radius:30,name:"Los Angeles"},{id:1450,slug:"guadalajara",type:"official",location:{latitude:20.65969879999999,longitude:-103.3496092},centerpoint:[-103.3496092,20.65969879999999],mailchimp_id:"0154de5655",radius:10,name:"Guadalajara"},{id:1447,slug:"oakland",type:"official",location:{latitude:37.79831556913852,longitude:-122.25940509567872},centerpoint:[-122.25940509567872,37.79831556913852],mailchimp_id:"da0894a0e6",radius:6,name:"Oakland"},{id:1444,slug:"san-francisco",type:"official",location:{latitude:37.7749295,longitude:-122.4194155},centerpoint:[-122.4194155,37.7749295],mailchimp_id:"f30df08e52",radius:5,name:"San Francisco"},{id:1441,slug:"portland",type:"official",location:{latitude:45.53316863144605,longitude:-122.6352310180664},centerpoint:[-122.6352310180664,45.53316863144605],mailchimp_id:"27c0467a17",radius:9,name:"Portland"},{id:1438,slug:"seattle",type:"official",location:{latitude:47.6062095,longitude:-122.3320708},centerpoint:[-122.3320708,47.6062095],mailchimp_id:"baadb78d87",radius:8,name:"Seattle"},{id:1435,slug:"vancouver",type:"official",location:{latitude:49.2827291,longitude:-123.1207375},centerpoint:[-123.1207375,49.2827291],mailchimp_id:"da30e0d7dc",radius:7,name:"Vancouver"}];axiosRetry__default.default(Axios__default.default,{retries:3,retryDelay:axiosRetry__default.default.exponentialDelay});const jsonpack=require("jsonpack"),GATSBY_WP_BASEURL="https://cms.vibemap.com",REST_PATH="/wp-json/wp/v2/",helpers=require("./helpers.js"),postCategories=require("../dist/postCategories");let vibeTaxonomy=[],activityCategories=[];try{const b=require("../dist/vibesFromCMSTaxonomy.zip.json");vibeTaxonomy=jsonpack.unpack(b)}catch(e){console.log("Error with packed vibes ",e)}try{const d=require("../dist/activityCategories.zip.json");activityCategories=jsonpack.unpack(d)}catch(e){console.log("Error with packed activityCategories ",e)}const defaultFilters={categories:[],cities:[],vibesets:[],vibes:[]},getTaxonomyIds=(e,t=["chill"])=>{switch(e){case"category":return t.map(e=>{const t=helpers.filterList(activityCategories,e,"slug");return 0<t.length?t.map(e=>e.id):[]});case"vibe":return t.map(e=>{const t=helpers.filterList(vibeTaxonomy,e,"slug");return 0<t.length?t.map(e=>e.id):[]});case"cities":return t.map(e=>{const t=helpers.filterList(cities,e,"slug");return 0<t.length?t.map(e=>e.id):[]})}return[]},fetchBadges=async()=>{var e=GATSBY_WP_BASEURL+REST_PATH+"badges";return await Axios__default.default.get(e).catch(e=>console.error(e))},fetchCities=async(e=50)=>{e=`?_fields=id, link, name, radius, slug, title, acf, type
    &per_page=`+e,e=GATSBY_WP_BASEURL+REST_PATH+"city"+e;return await Axios__default.default.get(e).catch(e=>console.error(e))},fetchNeighborhoods=async(e=defaultFilters,t=1,a=100)=>{var i=Axios__default.default.CancelToken.source(),o=GATSBY_WP_BASEURL+"/wp-json/wp/v2/neighborhoods?_fields=id, slug, type, link, _links, title, categories, vibe, acf, content, featured_media, featured_media_src_url";console.log("Wordpress URL ",o);let r=await Axios__default.default.get(o,{cancelToken:i.token,params:{_embed:!0,per_page:a,page:1<=t?t:1,categories:e.category,vibesets:e.vibesets.toString()}}).catch(e=>{console.error(e)});return r.numPages=parseInt(r.headers["x-wp-totalpages"]),r},fetchActivityCategories=async(e=defaultFilters,t=1,a=100,i)=>{var o=async(e=1,t=100)=>{var a=Axios__default.default.CancelToken.source(),i="activity-category",t=GATSBY_WP_BASEURL+`/wp-json/wp/v2/${i}?per_page=${t}&page=`+e,e=(console.log(`Fetching ${i} from `+t),await Axios__default.default.get(t,{cancelToken:a.token}).catch(e=>{console.error(e)}));return e.data};let r=await o(t,a),s=!0;var l;let n=t;for(console.log("Has more?  ",r.length,n*a);s;)r.length>=n*a?(l=await o(n+=1).catch(e=>console.error(e)),r=r.concat(l)):s=!1;return console.log("Got this many activities: ",r.length),r},fetchCategories=async(e=defaultFilters,t,a)=>{var i=Axios__default.default.CancelToken.source();let o=await Axios__default.default.get(GATSBY_WP_BASEURL+"/wp-json/wp/v2/categories/",{cancelToken:i.token}).catch(e=>{console.error(e)});return o.numPages=parseInt(o.headers["x-wp-totalpages"]),o},getCityInfo=(t="San Francisco",a=null)=>{let e=null;a&&(a=a.toString(),i=cities.filter(e=>e.slug===a.toString()),e=0<i.length?i[0]:null);var i=cities.filter(e=>e.name===t);return e=0<i.length?i[0]:null},filterNeighborhoods=(e,t="San Francisco",a=null)=>{var i;a&&(a=a.toString(),i=cities.filter(e=>e.slug===a.toString()),t=0<i.length?i[0].title.rendered:null);return t||a?filter(e,e=>e.city===t||e.title.includes(t)):e},fetchVibeTaxonomy=async(e=1,t=100,a=["acf","id","link","name","slug","description"])=>{var i=async(e=1,t=100)=>{t=`?_fields=${a.join(",")}&per_page=${t}&page=`+e,e=GATSBY_WP_BASEURL+REST_PATH+"vibe"+t;return(await Axios__default.default.get(e).catch(e=>console.error(e))).data};let o=await i(e,t),r=!0;var s;let l=e;for(;r;)o.length>=l*t?(s=await i(l+=1).catch(e=>console.error(e)),o=o.concat(s)):r=!1;return o},getGroups=async({city:t=null,per_page:e=100}={})=>{e="?_fields=id,date,slug,title,acf&per_page="+e,e=GATSBY_WP_BASEURL+REST_PATH+"group"+e;const a=(await Axios__default.default.get(e).catch(e=>(console.error(e.response.statusText),{error:!0,data:{data:[]},message:e}))).data;e=a&&"object"==typeof a?a.filter(e=>{return e.acf.map&&t?t==e.acf.map.city:(e.title=e.title.rendered,!0)}):[];return e?{error:!1,data:e,message:`Got ${e.length} groups`}:{error:!0,data:[],message:"No data for groups"}},getPosts=async(e=defaultFilters,t=!1,a=20,i=["id","date","slug","status","type","link","title","content","excerpt","author","categories","vibe","blocks","acf","featured_media","featured_media_src_url"],o=!1,r=!1)=>{o=o?"&_embed":"",i="?_fields="+i.join(",");const s=new Date;i=""+GATSBY_WP_BASEURL+REST_PATH+"posts"+i+o+(r?s.toISOString():"");const l={per_page:a,cities:getTaxonomyIds("cities",e.cities).toString(),sticky:!0};e.category&&0<e.category.length&&(l.category=getTaxonomyIds("category",e.category).toString()),e.vibes&&0<e.vibes.length&&(l.search=e.vibes.join(", "));let n=await Axios__default.default.get(i,{params:l}).catch(e=>{console.error("Wordpress error",e)}),c=(l.sticky=!1,await Axios__default.default.get(i,{params:l}).catch(e=>console.error(e)));o=c.data.filter(e=>!0!==e.acf.hide_post).map(t=>{var e=postCategories.filter(e=>e.id===t.categories[0]);return t.category=e?e[0].name:"Guide",t});return!0===t?n:(c.data=c?n.data.concat(o):n,c)},getPost=async e=>{Axios__default.default({url:"https://cms.vibemap.com/graphql",method:"post",data:{operationName:"PostDetails",query:`query PostDetails($id: String!) {
      posts {
        nodes {
          id
          slug
        }
      }
    }
    `,variables:{id:e}}}).then(e=>{console.log(e.data)})};exports.fetchActivityCategories=fetchActivityCategories,exports.fetchBadges=fetchBadges,exports.fetchCategories=fetchCategories,exports.fetchCities=fetchCities,exports.fetchNeighborhoods=fetchNeighborhoods,exports.fetchVibeTaxonomy=fetchVibeTaxonomy,exports.filterNeighborhoods=filterNeighborhoods,exports.getCityInfo=getCityInfo,exports.getGroups=getGroups,exports.getPost=getPost,exports.getPosts=getPosts,exports.getTaxonomyIds=getTaxonomyIds;
